<?xml version="1.0" encoding="utf-8"?>
<LinearLayout
    xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    xmlns:tools="http://schemas.android.com/tools"
    android:id="@+id/main"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:gravity="top"
    android:background="#2196F3"
    tools:context=".MainActivity">
    <LinearLayout
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_gravity="right">
        <TextView
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="추가 및 삭제 가능"
            android:layout_marginEnd="70dp"/>
        <androidx.appcompat.widget.AppCompatButton
            android:id="@+id/addBtn"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_marginEnd="10dp"
            android:text="@string/Add"
            android:background="#314CFF"
            android:textColor="#FFFFFF"
            android:textSize="20sp"/>
        <androidx.appcompat.widget.AppCompatButton
            android:id="@+id/delBtn"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="@string/delete"
            android:background="#FF1C1C"
            android:textColor="#050505"
            android:textSize="20sp"/>
    </LinearLayout>
    <LinearLayout
        android:id="@+id/layout"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:orientation="vertical">
    </LinearLayout>
<!--동적 아이템을 추가할 전용 레이아웃-->
    <LinearLayout
        android:id="@+id/dynamicLayout"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:orientation="vertical"/>

</LinearLayout>
===================================================================
package com.iot.memo;

import static com.iot.memo.SQLite.IS_DELETED;
import static com.iot.memo.SQLite.TABLE_NAME;
import static com.iot.memo.SQLite.UPDATE_DATE;

import android.annotation.SuppressLint;
import android.app.AlertDialog;
import android.content.ContentValues;
import android.content.DialogInterface;
import android.content.Intent;
import android.database.Cursor;
import android.database.sqlite.SQLiteDatabase;
import android.graphics.Color;
import android.os.Bundle;
import android.util.Log;
import android.view.View;
import android.view.ViewGroup;
import android.widget.Button;
import android.widget.CheckBox;
import android.widget.CompoundButton;
import android.widget.LinearLayout;
import android.widget.TextView;

import androidx.activity.EdgeToEdge;
import androidx.activity.result.ActivityResultLauncher;
import androidx.annotation.NonNull;
import androidx.appcompat.app.AppCompatActivity;
import androidx.core.graphics.Insets;
import androidx.core.view.ViewCompat;
import androidx.core.view.WindowInsetsCompat;

import java.time.Instant;
import java.time.ZoneId;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.List;
import java.util.Locale;


public class MainActivity extends AppCompatActivity {
    private LinearLayout dynamicLayout;
    private Button addBtn;
    private Button delBtn;
    private TextView txtId;
    private CheckBox chId;
    private ActivityResultLauncher<Intent> launcher;
    private SQLite sqLite;
    private List<Integer> chckBoxIds = new ArrayList<>();
    private List<Integer> delIds = new ArrayList<>(); //체크된 id배열
    private List<Integer> txtIds = new ArrayList<>();

    public static final String Tag_MSG = "id";

    @SuppressLint("MissingInflatedId")
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        EdgeToEdge.enable(this);
        setContentView(R.layout.activity_main);
        ViewCompat.setOnApplyWindowInsetsListener(findViewById(R.id.main), (v, insets) -> {
            Insets systemBars = insets.getInsets(WindowInsetsCompat.Type.systemBars());
            v.setPadding(systemBars.left, systemBars.top, systemBars.right, systemBars.bottom);
            return insets;
        });
//        ActionBar actionBar = getSupportActionBar();
//        actionBar.hide();
        //버튼 초기화
        addBtn = findViewById(R.id.addBtn);
        delBtn = findViewById(R.id.delBtn);
        delBtn.setEnabled(false);
        delBtn.setVisibility(View.GONE);


        //SQL(조회, 삭제-수정)
        sqLite = new SQLite(this);
        refreshUI();


        addBtn.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                Intent intent = new Intent(MainActivity.this, EditTextActivity.class);
                startActivity(intent);
                finish();//현재화면 닫기(edit에서 저장 후 새화면 띄우기)
//                launcher.launch(intent);

            }
        });

        //체크박스 선택여부 체크
        boolean anyChecked = false;
        for (int id : chckBoxIds) {
            CheckBox cb = findViewById(id);
            if (cb != null && cb.isChecked()) {
                anyChecked = true;
                break;
            }
        }
        if (anyChecked) {
            delBtn.setEnabled(true);
            delBtn.setVisibility(View.VISIBLE);
        } else {
            delBtn.setEnabled(false);
            delBtn.setVisibility(View.GONE);
        }

        //삭제버튼 클릭시
        delBtn.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
//                int result = 0;
                //삭제여부 묻기
                queAlert();
//                for(int id : delIds){
//                    result += updateDB(id);
//                }
//                //화면 갱신하기
//                if(result == delIds.size()){
//                    refreshUI();  // 별도 메서드로 분리하는 것이 좋음
//                }

            }
        });

    }//onCreate end

    //시간설정하기
    private static final ZoneId ZONE = ZoneId.of("Asia/Seoul");
    private static final DateTimeFormatter FMT =
            DateTimeFormatter.ofPattern("yyyy-MM-dd hh:mm", Locale.KOREA);
    private static String formatEpochMillis(long millis) {
        return Instant.ofEpochMilli(millis).atZone(ZONE).format(FMT);
    }

    //동적 생성
    private void createView(String text, String date) {

        //동적레이아웃(체크박스, 텍스트뷰) 생성
        // 1. 부모 레이아웃 가져오기(기존에 있는 레이아웃)
        LinearLayout parentLayout = findViewById(R.id.dynamicLayout);
        // 2. 자식 레이아웃 생성(수평방향)
        LinearLayout rowLayout = new LinearLayout(MainActivity.this);
        rowLayout.setOrientation(LinearLayout.HORIZONTAL);
        // 정렬 추가
        LinearLayout.LayoutParams params = new LinearLayout.LayoutParams(
                LinearLayout.LayoutParams.WRAP_CONTENT,
                ViewGroup.LayoutParams.WRAP_CONTENT
        );
        params.setMargins(16, 0, 0, 0);     //왼쪽여백 추가
        // 3. 체크박스 생성
        CheckBox dynamicCheckBox = new CheckBox(this);

        int id = View.generateViewId();
        dynamicCheckBox.setId(id);
        dynamicCheckBox.setTag("checkBox_" + id);
        dynamicCheckBox.setLayoutParams(params);
        chckBoxIds.add(id);
        Log.i("test", "ckidx : "+ id);
        dynamicCheckBox.setOnCheckedChangeListener(new CompoundButton.OnCheckedChangeListener() {
            @Override
            public void onCheckedChanged(@NonNull CompoundButton buttonView, boolean isChecked) {
                //체크박스가 속한 부모 레이아웃
                ViewGroup parent = (ViewGroup) buttonView.getParent();
                if(parent instanceof ViewGroup){
                    ViewGroup parentGroup = (ViewGroup) parent;
                    int count = parentGroup.getChildCount();
                    for(int i = 0; i < count; i++){
                        View child = parent.getChildAt(i);
                        if(child instanceof TextView){
                            //같은 줄에 있는 텍스트뷰의 텍스트 가져오기
                            String text = ((TextView) child).getText().toString();
                            if(text != null && !text.isEmpty()){
                                try{
                                    int id = Integer.parseInt(text.split(":")[0]);
                                    //index list 저장하기
                                    if(!delIds.contains(id)){
                                        delIds.add(id);
                                    }else{
                                        delIds.remove(Integer.valueOf(id));
                                    }
                                }catch(NumberFormatException e){
                                    Log.e("CheckBoxError", "ID 파싱 오류 : " + text.split(":")[0]);
                                }
                            }
                        }
                    }
                }
                //삭제버튼 활성화/비활성화
                updateDeleteButtonState();
            }
        });
        // 4. 텍스트뷰 생성
        TextView dynamicTextView1 = new TextView(this);
        dynamicTextView1.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                //수정화면으로 이동
                Intent intent = new Intent(MainActivity.this, EditTextActivity.class);
                String text = dynamicTextView1.getText().toString();
                int txtId = Integer.parseInt(text.split(":")[0]);
                intent.putExtra(String.valueOf(Tag_MSG), txtId);
                startActivity(intent);
            }
        });
        dynamicTextView1.setId(id);
        dynamicTextView1.setTag("textView1_" + id);
        Log.i("test", "txtidx : "+ id);
        dynamicTextView1.setLayoutParams(params);
        dynamicTextView1.setText(text);
        txtIds.add(id);
        dynamicTextView1.setWidth(500);
        dynamicTextView1.setHeight(100);
        dynamicTextView1.setBackgroundColor(Color.rgb(250,250,0));
        TextView dynamicTextView2 = new TextView(this);
        //dynamicTextView2.setText("동적생성!");
        dynamicTextView2.setLayoutParams(params);
        int id2 = View.generateViewId();
        dynamicTextView2.setId(id2);
        dynamicTextView2.setTag("textView2_" + id2);
        dynamicTextView2.setLayoutParams(params);
        dynamicTextView2.setText(date);
        dynamicTextView2.setWidth(500);
        dynamicTextView2.setHeight(100);
        dynamicTextView2.setBackgroundColor(Color.rgb(250,250,0));
        // 5. rowLayout에 체크박스, 텍스트뷰 추가
        rowLayout.addView(dynamicCheckBox);
        rowLayout.addView(dynamicTextView1);
        rowLayout.addView(dynamicTextView2);
        // 6. rowLayouot을 parent에 추가
        parentLayout.addView(rowLayout);
    }

    //삭제 버튼 활성/비활성화
    private void updateDeleteButtonState(){
        boolean anyChecked = false;
        //checkBox = findViewById(R.id.checkBox);

//        if(checkBox != null && checkBox.isChecked()){
//            anyChecked = true;
//        }
        for (int id : chckBoxIds) {
            CheckBox cb = findViewById(id);
            if (cb != null && cb.isChecked()) {
                anyChecked = true;
                break;
            }
        }
        delBtn.setEnabled(anyChecked);
        delBtn.setVisibility(anyChecked ? View.VISIBLE : View.GONE);
    }

    //삭제여부 문의
    private void queAlert(){
        new AlertDialog.Builder(this)
                .setTitle("알림")
                .setMessage("삭제하시겠습니까?")
                .setPositiveButton("확인", new DialogInterface.OnClickListener() {
                    @Override
                    public void onClick(DialogInterface dialog, int which) {
                        //확인버튼 클릭 시 동작
                        //삭제진행
                        int result = 0;
                        for(int id : delIds){
                            result += updateDB(id);
                        }
                        //화면 갱신하기
                        if(result == delIds.size()){
                            refreshUI();  // 별도 메서드로 분리하는 것이 좋음
                        }

                    }
                })
                .setNegativeButton("취소", new DialogInterface.OnClickListener(){
                    @Override
                    public void onClick(DialogInterface dialog, int which) {
                        //취소버튼 클릭 시 동작
                        dialog.dismiss();   //창닫기

                    }
                })
                .show();
    }

    //데이터 조회
    private Cursor readDB(){
        SQLiteDatabase db = sqLite.getReadableDatabase();
        Cursor cursor = null;
        try{
            cursor = db.rawQuery("SELECT * FROM " + TABLE_NAME + " WHERE " + IS_DELETED  + " = 0", null);
        }catch(Exception e){
            Log.e("readDB", "DB query error", e);
        }
        return cursor;
    }//0=false, 1=true

    private void refreshUI() {
        //sqLite = new SQLite(this);
        //기존 동적레이아웃 초기화
        LinearLayout parentLayout = findViewById(R.id.dynamicLayout);
        parentLayout.removeAllViews();

        Cursor cursor = null;
        try{
            cursor = readDB();
            displayDB(cursor);
        }finally{
            if(cursor != null && !cursor.isClosed()){
                cursor.close();
            }
        }
    }

    //인덱스, 제목, 내용, 입력날짜, 수정날짜, 삭제여부
    //index, title, content, createDate, updateDate, delete(default : false)
    //조회한 값을 textview에 매핑
    private void displayDB(Cursor cursor) {
        if (cursor == null) {
            Log.e("displayDB", "Cursor is null");
            return;
        }
        //StringBuilder builder1 = new StringBuilder();
        int num = 1;
        while (cursor.moveToNext()) {
            StringBuilder builder1 = new StringBuilder();
            StringBuilder builder2 = new StringBuilder();
            long id = cursor.getLong(0);
            builder1.append(id).append(": ");
            String title;
            if (cursor.isNull(1)) {
                title = "";
            } else {
                title = cursor.getString(1);
            }
            long updateDate = cursor.getLong(4);
            builder1.append(title).append("\n");
            builder2.append(formatEpochMillis(updateDate)).append("");
            String date = builder2.toString();
            //text, checkBox 동적 생성하기
            createView(builder1.toString(), date);
//            if (id == 1) {
//                textView1.setText(builder1.toString());
//            } else {
//                createView(builder1.toString());
//            }


        }
    }
    //삭제 시(수정)
    private int updateDB(int id){
        String uId = String.valueOf(id);
        SQLiteDatabase db = sqLite.getWritableDatabase();
        ContentValues values = new ContentValues();
        values.put(IS_DELETED, 1);
        values.put(UPDATE_DATE, System.currentTimeMillis());
        int result = db.update(TABLE_NAME, values, "id = ?", new String[]{uId});
        return result;
    }
}
